trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: tomcat-credentials

stages:
  - stage: Build
    displayName: ðŸ“¦ Build WAR
    jobs:
      - job: Build
        steps:
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'package'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: true

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)/target'
              Contents: '*.war'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'quizappjee-artifact'

  - stage: Deploy
    displayName: ðŸš€ DÃ©ploiement Tomcat
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployToTomcat
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'quizappjee-artifact'
              downloadPath: '$(System.ArtifactsDirectory)'

          - script: |
              echo "ðŸ“¡ DÃ©ploiement vers Tomcat..."
              curl --fail --user "$(TOMCAT_USERNAME):$(TOMCAT_PASSWORD)" \
                   --upload-file "$(System.ArtifactsDirectory)/quizappjee-artifact/*.war" \
                   "http://192.168.100.36:8080/manager/text/deploy?path=/QuizAppJEE&update=true"
            displayName: "ðŸ’¾ DÃ©ploiement WAR vers Tomcat"

